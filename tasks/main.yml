---
- name: install OpenResty apt key
  apt_key: data={{ openresty_apt_key }}

- name: add OpenResty apt repo
  apt_repository: repo="deb http://openresty.org/package/ubuntu {{ ansible_lsb.codename }} main"

- name: install OpenResty package
  apt: name=openresty
  register: install

# This is required so that when the following task replaces the defaulct nginx.conf
# with a default server listening on 80, those agents aren't orphaned as they will
# cause subsequent attempts to start nginx to fail with a conflict on 80
- name: stop process started by install
  when: install | changed
  service: name=openresty state=stopped

- name: link /etc/openresty to /etc/nginx
  file:
    state: link
    src: /etc/openresty
    path: /etc/nginx

- debug: var=ansible_service_mgr

- name: link openresty init script as nginx for service
  file:
    state: link
    src: /etc/init.d/openresty
    path: /etc/init.d/nginx

- name: create nginx service for systemd
  template:
    src: etc/systemd/system/nginx.service.j2
    dest: /etc/systemd/system/nginx.service
    owner: root
    group: root
    mode: 0644
  when: ansible_service_mgr == 'systemd'

- name: create standard nginx directories
  file:
    state: directory
    path: "{{ item }}"
  with_items:
    - /etc/nginx/conf.d
    - /etc/nginx/sites-enabled
    - /etc/nginx/sites-available
    - /var/log/nginx

- name: install default nginx configuration
  template:
    src: etc/nginx/{{ item }}.j2
    dest: /etc/nginx/{{ item }}
  with_items:
    - nginx.conf
    - conf.d/defaults
  notify: restart nginx
